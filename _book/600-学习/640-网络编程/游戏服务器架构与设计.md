

[TOC]

# 游戏服务器的交互 

## 无状态服务器的设计

除了业务逻辑以外，无状态的服务器不需要特殊的设计，我们所有的内容都包装在协议之内，没有上下文关联，一条协议即包含了所有的内容

## 有状态服务器设计方案

只要是高实时，高并发的服务器，必须使用有状态的服务器，也就是保持一个长连接

## 集群的几种方式

- 高性能集群
- 负载均衡集群
- 高可用性集群

## 数据库方案

- 建立数据库的主从规格，从数据库作为备份使用

- 使用数据库的读写分离

  主数据库负责写入，更新等操作，从数据库负责读操作

- 使用两台主数据库互相备份

# **游戏大厅**

## 中间件的分类

- 远程过程调用中间件rpc

  一个应用程序使用rpc来远程执行一个位于不同地址空间里的过程，并且从效果上看和执行本地调用相同。

- 面向消息的中间件mon

  高效可靠的消息传递机制进行平台无关的数据交流，并基于数据通信来进行分布式系统的集成，通过消息传递和消息排队模型，可扩展

- 对象请求代理中间件orb

## 聊天服务

### 聊天内容的获取和分发

- 第一种就是Http标准的协议，通过post方式上传聊天的内容，并且通过后端web服务将聊天内容分发给需要接受消息的人

- 第二种就是使用tcp协议，协议规则和协议内容自己制定，

  传输格式可以定义为：[header|size|body]  

# 实时交互服务器

## 使用udp的方案

**udp的特点**

- udp是一个非连接的协议，传输在发送端，udp的传输速度仅仅受应用程序生成数据的速度，计算机的能力和传输带宽的限制，在接收端，udp把每个消息段放在队列种，应用程序每次从队列中读取一个消息段。

- 由于传输不建立连接，因此也就不需要维护连接状态，包括收发状态等，因此一台服务器可同时向多个客户机传输相同的消息

- udp信息包的标题很短，只有8个字节，相对于tcp的20个字节信息包，开销少

- 吞吐量不受拥挤算法控制，只受应用程序生成数据的速率，传输带宽，源端和终端主机性能的限制

- udp尽最大努力交互，既不保证可靠，因此主机不需要维护复杂的连接状态表

- udp是面向报文的，既不拆分，也不合并，而是保留边界。因此应用需要选择合适的报文大小。

## 协议包的设计与实现

**设计要点**

- 安全行

  指的是在数据的发送过程中，不能被中间攻击人将包的内容解码修改了再发送给指定的接收方，

- 完整性

  指的是我们要知道包有没收全，再udo的情况下，有很大概率会出现丢包，数据收不全的情况，tcp也会出现一次性接收不全的情况，再这种情况下，程序要保证包的完整性。

## 断线重连

**当服务器或者客户端出错崩溃的时候，我们将无法接收到对方发送过来的协议和seq序列，这时候我们是否有对策将序列号恢复呢，具体方案有：**

- 序列号重置

  当出现短线或者崩溃的情况，接收到序号不为1的协议，此时我们将发送一段需要将序列号重置的请求，当然这种方案很容易被中间人攻击，因为中间人可以模拟发送方，要求将序列号重置，之后就再也没有任何顾虑了。

- 请求对方序列号

  请求最后一次序列号是多少，如果我们是服务器端，可以每接收到一段序列号就持久化再缓存或磁盘，当服务器宕机的时候，我们恢复最后一次的seq号，然后强制要求客户端更新seq号为当前服务器的seq号，

- 客户端要求服务器端更新序列号为客户端最新序列号，服务器不需要持久化序列号内容

  这种方式的好处是：服务器只需要从客户端拿数据，缺点是容易被中间人攻击，且客户端需要保存当前序列号以备将来告知服务器

**udp协议相关的问题**

- udp协议格式规定，Udp理论上可以达到65507，如果发送的数据超过65507字节，send或者sendto函数会返回错误1

- udp能否发送65507，还和udp发送缓存区的大小相关，如果发送缓存区小于65507，在发送一个数据包为65507字节的时候，也会报错1

- udp是不可靠的传输协议，为了减少丢包的风险，我们最好能控制udp包在下层协议的传输过程种不被切割。在下层数据链路层最大传输层单元是1500字节的情况下，要想ip不分包，那么udp包大小应该为1500-ip头（20）-udp头（8）=1472。不过鉴于internet上的标准mtu的值为576，所以建议Udp不要超过548字节。

- 如果数据较大，可以进行压缩再传输。

**降低丢包率的方法**

- 冗余传输的方式

  一般采用较多的是延时双发送，双发指的是将原来单发前后连续的两个协议包合并成一个大的协议包发送，这样发送的数据量是原来的2倍，这种方式提高丢包率的原理比较简单，在偶数包全丢的情况下，依然能够还原出完整的数据，

# 服务器承载量和客户端优化方案

## 心跳服务

**心跳的设计**

- 在tcp/ip的协议层，本身就存在心跳包的设计，就是tcp协议中的SO_KEEPALIVE

  系统默认是设置两个小时的心跳频率，不可靠

- 应用层的心跳

**心跳包的协议**

心跳包是采用间隔发送数据包的方式来实现存活消息发送，在心跳包服务器中，我们可以记录日志，调整心跳节律，通知逻辑服务器做一些事情，

# 分布式服务器

分布式中一个节点可能由某一个集群来完成，而一个集群只专心做同样的任务，每个集群机器都提供相同的服务。

## 高并发数据库的策略

- 数据库主从复制
- 数据库的读写分离，数据的更新都是针对于主数据库，但是读可以是从数据库
- 从数据库的反向代理
- 垂直分割，将主服务器进行拆分
- 水平分割，将从服务器进行拆分，